
Shared Information between Hidden Representations in NMT
========================================================

This repository contains code to measure the amount of shared information between hidden encoder-side representations in neural machine translation models.

Usage
=====

First, train a model according to [documentation for seq2seq-attn](https://github.com/harvardnlp/seq2seq-attn).

1\. Generate a description file
------------------------------

Then invoke `describe.lua` like so:

```shell
th describe.lua -model XYZ.t7 -src_dict XYZ.src.dict -targ_dict XYZ.targ.dict -src_file XYZ.tok -output_file XYZ.t7
```

`describe.lua` has an additional option specifying the layer to take

```shell
th describe.lua -model XYZ.t7 -src_dict XYZ.src.dict -targ_dict XYZ.targ.dict -src_file XYZ.tok -output_file XYZ.t7 -enc_layer 1
```

Note: a network with `n` LSTM layers has `2n` hidden layers; each LSTM layer has a memory cell and a hidden cell. Odd layer numbers denote memory cells, and even layer numbers denote the hidden cells, in forward pass order.

All of the options `describe.lua` takes are:

```
-model
-src_dict
-targ_dict
-src_file
-output_file
-enc_layer
```

You will want to generate a description file for each of the models you want to compare. To be compared, description files must be generated on the same `-src_file`.

2\. Generate a comparison table
------------------------------

First, create a text file that contains a list of descriptions for the models you want to compare. It should contain one absolute file location per line, each one pointing to a `t7` file generated by `describe.lua` (specified by the `output_file` option). For instance, you might create `description_list.txt` with:

```
/home/me/desc-1.t7
/home/me/desc-2.t7
/home/me/desc-2.t7
```

which will compares three networks, doing a total of 6 comparisons (networks are not compared with themselves).

Then choose a predictor -- linear (`linear-predictors`), linear with pca (`pca-predictors`), or single-layer MLP (`nonlinear-predictors`). Invoke the corresponding script like so:

```shell
th pca-predictors -desc_list description_list.txt -out_file comparison_table.json
```

Replacing `pca-predictors` with whichever script you wish to run.

The comparison table will contain the MSE for each dimension for each ordered pair of models, and is written in json format. `-desc_list` and `-out_file` are the only options these scripts accept.

3\. Visualize the comparison table
---------------------------------

Visualization tools reside in the JavaScript file `visualize.js`. Use this in an HTML file to generate visualizations. By default, the visualization loads data by making an XHR request for the wanted JSON file, so you will need to run a local server in order to do this, rather than just view the file with `file://`.

`visualize.js` provides two functions: `render_table` and `render_small_table`. The first renders plots of the dimensionwise MSEs and their geometric means; the second renders a matrix heatmap of differential entropies of the error distributions. Their prototypes are:

```javascript
render_table("filename.json", "destination-element-id");
render_small_table("filename.json", "destination-element-id");
```

A brief example:

```html
<html>
  <body>
    <div id="table-spot"></div>
    <script src="visualize.js"></script>
    <script>
      render_table('comparison_table.json', 'table-spot');
    </script>
  </body>
</html>
```
